<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>UkrMova Pro</title>
<style>
:root{--blue:#00a2ff;--red:#ff4d4d;--green:#2ecc71;--gold:#f1c40f;--dark:#d32f2f;--gray:#555;--light:#f8f8f8}
body{margin:0;padding:0;font-family:sans-serif;color:#000;background:url('https://upload.wikimedia.org/wikipedia/commons/thumb/4/49/Flag_of_Ukraine.svg/2560px-Flag_of_Ukraine.svg.png') no-repeat center center fixed;background-size:cover;min-height:100vh;position:relative}
body::before{content:"";position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.75);z-index:-2}
.screen{display:none;padding:20px;flex-direction:column;min-height:100vh;box-sizing:border-box;position:relative;z-index:1}
.active{display:flex;animation:fadeIn .3s ease}
.card{background:rgba(255,255,255,0.92);backdrop-filter:blur(10px);padding:20px;border-radius:20px;border:1px solid #444;margin:auto;width:100%;max-width:450px;box-shadow:0 0 20px rgba(0,0,0,0.3);position:relative;z-index:2}
.btn{background:var(--blue);color:#fff;border:none;padding:12px;border-radius:10px;font-weight:700;width:100%;margin:5px 0;cursor:pointer;transition:all .2s}
.btn:hover{transform:scale(1.03);box-shadow:0 0 12px rgba(0,162,255,.5)}
.btn.green{background:var(--green)}
.btn.danger{background:var(--red)}
.money{font-size:32px;font-weight:900;color:var(--gold);text-shadow:0 0 10px #f1c40f}
.nickname{font-size:28px;font-weight:bold;margin:10px 0;cursor:pointer}
.gold-nick{color:var(--gold);text-shadow:0 0 10px var(--gold)}
.lvl-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;max-height:40vh;overflow-y:auto;padding:10px}
.lvl{background:rgba(51,51,51,0.7);padding:12px 0;border-radius:10px;opacity:0.6;transition:all .3s;border:1px solid #ccc}
.lvl.open{opacity:1;background:var(--blue);border:2px solid white;box-shadow:0 0 15px var(--blue);color:white}
#admin-panel{border:2px dashed var(--red);padding:20px;margin-top:20px;display:none;background:rgba(255,255,255,0.95);text-align:left;border-radius:15px;box-shadow:0 0 20px rgba(255,0,0,0.2)}
input, select{background:#fff;border:1px solid #ccc;padding:10px;border-radius:8px;color:#000;width:calc(100% - 20px);margin:6px 0}
table{width:100%;border-collapse:collapse;margin:15px 0}
th, td{padding:10px;border:1px solid #ddd;text-align:left}
th{background:#eee;cursor:pointer}
th:hover{background:#ddd}
#player-search{width:100%;margin-bottom:10px}
#stats{margin:15px 0;padding:10px;background:#f0f8ff;border-radius:8px}
.modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:9999;justify-content:center;align-items:center}
.modal-content{background:#fff;padding:25px;border-radius:15px;max-width:500px;width:90%;max-height:90vh;overflow-y:auto}
.close-modal{float:right;cursor:pointer;font-size:24px}
.log-box{max-height:200px;overflow-y:auto;border:1px solid #ccc;padding:10px;margin:10px 0;background:#f8f8f8;border-radius:8px}
.log-entry{padding:6px 0;border-bottom:1px solid #eee}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
</style>
</head>
<body>

<div id="auth-screen" class="screen active">
  <div class="card">
    <h2 style="color:var(--gold)">UKRMOVA PRO</h2>
    <input type="text" id="nick" placeholder="Нікнейм">
    <input type="password" id="pass" placeholder="Пароль">
    <button class="btn" onclick="auth()">УВІЙТИ</button>
  </div>
</div>

<div id="menu" class="screen">
  <div class="card">
    <h3 onclick="admT()" style="cursor:pointer">МЕНЮ</h3>
    <div class="nickname" id="playerNick"></div>
    <div class="money"><span id="mon">0</span> ₴</div>

    <button class="btn" onclick="showThemes()">ГРАТИ</button>
    <button class="btn" style="background:#333" onclick="loadT()">ТОП</button>
    <button class="btn green" onclick="show('shop')">МАГАЗИН</button>

    <div id="admin-panel">
      <b style="color:var(--red);cursor:pointer" onclick="closeAdm()">❌ ЗАКРИТИ АДМІНКУ</b><br><br>

      <div id="stats">
        <b>Статистика:</b><br>
        Гравців: <span id="totalPlayers">0</span><br>
        Загальна сума грошей: <span id="totalMoney">0</span> ₴<br>
        Онлайн: <span id="onlineCount">0</span>
      </div>

      <input type="text" id="player-search" placeholder="Пошук по ніку / юзу..." oninput="filterPlayers()">

      <table id="playersTable">
        <thead>
          <tr>
            <th onclick="sortTable(0)">Юз</th>
            <th onclick="sortTable(1)">Нік</th>
            <th onclick="sortTable(2)">Гроші</th>
            <th onclick="sortTable(3)">Рівень</th>
            <th onclick="sortTable(4)">Пароль</th>
            <th>Дії</th>
          </tr>
        </thead>
        <tbody id="player-table-body"></tbody>
      </table>

      <br>
      <button class="btn danger" onclick="massAction('add')">+1000 всім</button>
      <button class="btn danger" onclick="massAction('subtract')">-500 всім</button>
      <button class="btn danger" onclick="clearAllData()">Очистити БАЗУ (не звертатись!)</button>
      <button class="btn" onclick="exportCSV()">Експорт у CSV</button>

      <br><br>
      <h4 style="color:var(--blue)">Останні дії адміна</h4>
      <div id="admin-log" class="log-box">Завантаження...</div>

      <br>
      <h4 style="color:var(--blue)">Лог входів гравців</h4>
      <div id="user-log" class="log-box">Завантаження...</div>
      <button class="btn" style="background:#ff9800" onclick="loadUserLog()">Оновити</button>
      <button class="btn danger" onclick="clearUserLog()">Очистити</button>
    </div>
  </div>
</div>

<!-- інші екрани без змін -->
<div id="shop" class="screen">...</div>
<div id="themes" class="screen">...</div>
<div id="levels" class="screen">...</div>
<div id="game" class="screen">...</div>
<div id="top" class="screen">...</div>

<!-- Модальне вікно редагування гравця -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <span class="close-modal" onclick="closeModal()">&times;</span>
    <h3>Редагувати гравця: <span id="editNick"></span></h3>
    <input type="hidden" id="editKey">
    <label>Гроші:</label><input type="number" id="editPoints"><br>
    <label>Рівень:</label><input type="number" id="editLvl"><br>
    <label>Пароль:</label><input type="text" id="editPass"><br>
    <button class="btn green" onclick="savePlayerEdit()">Зберегти</button>
    <button class="btn danger" onclick="deleteFromModal()">Видалити</button>
  </div>
</div>

<script>
// ... весь твій попередній JavaScript-код ...

// Додаємо нові функції для прокачаної адмінки

let playersData = []; // для пошуку та сортування

async function loadPlayers() {
  let r = await fetch(DB + "users/.json"), d = await r.json();
  let tbody = document.getElementById('player-table-body');
  tbody.innerHTML = '';
  playersData = [];

  if (!d || !Object.keys(d).length) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px">Гравців немає</td></tr>';
    document.getElementById('totalPlayers').innerText = '0';
    document.getElementById('totalMoney').innerText = '0';
    return;
  }

  let totalMoney = 0;
  let totalPlayers = 0;

  for (let key in d) {
    let u = d[key];
    totalPlayers++;
    totalMoney += u.points || 0;
    playersData.push({key, ...u});

    let tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${key}</td>
      <td>${u.name || key}</td>
      <td>${u.points || 0}</td>
      <td>${u.lvl || 1}</td>
      <td>${u.pass || '—'}</td>
      <td><button class="btn" onclick="openEditModal('${key}')">Редагувати</button></td>
    `;
    tbody.appendChild(tr);
  }

  document.getElementById('totalPlayers').innerText = totalPlayers;
  document.getElementById('totalMoney').innerText = totalMoney.toLocaleString();
}

function filterPlayers() {
  let input = document.getElementById('player-search').value.toLowerCase();
  let rows = document.querySelectorAll('#playersTable tbody tr');

  rows.forEach(row => {
    let text = row.textContent.toLowerCase();
    row.style.display = text.includes(input) ? '' : 'none';
  });
}

function sortTable(colIndex) {
  let table = document.getElementById('playersTable');
  let switching = true;
  let dir = "asc";
  let switchcount = 0;

  while (switching) {
    switching = false;
    let rows = table.rows;
    for (let i = 1; i < (rows.length - 1); i++) {
      let shouldSwitch = false;
      let x = rows[i].getElementsByTagName("TD")[colIndex];
      let y = rows[i + 1].getElementsByTagName("TD")[colIndex];
      let xVal = x.innerHTML.toLowerCase();
      let yVal = y.innerHTML.toLowerCase();

      if (colIndex === 2 || colIndex === 3) { // числа
        xVal = parseFloat(xVal) || 0;
        yVal = parseFloat(yVal) || 0;
      }

      if (dir == "asc") {
        if (xVal > yVal) {
          shouldSwitch = true;
          break;
        }
      } else if (dir == "desc") {
        if (xVal < yVal) {
          shouldSwitch = true;
          break;
        }
      }
    }

    if (shouldSwitch) {
      rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
      switching = true;
      switchcount++;
    } else {
      if (switchcount == 0 && dir == "asc") {
        dir = "desc";
        switching = true;
      }
    }
  }
}

function openEditModal(key) {
  fetch(DB + "users/" + key + ".json")
    .then(r => r.json())
    .then(u => {
      document.getElementById('editKey').value = key;
      document.getElementById('editNick').innerText = u.name || key;
      document.getElementById('editPoints').value = u.points || 0;
      document.getElementById('editLvl').value = u.lvl || 1;
      document.getElementById('editPass').value = u.pass || '';
      document.getElementById('editModal').style.display = 'flex';
    });
}

function closeModal() {
  document.getElementById('editModal').style.display = 'none';
}

async function savePlayerEdit() {
  let key = document.getElementById('editKey').value;
  let points = parseInt(document.getElementById('editPoints').value);
  let lvl = parseInt(document.getElementById('editLvl').value);
  let pass = document.getElementById('editPass').value;

  let r = await fetch(DB + "users/" + key + ".json");
  let u = await r.json();

  u.points = points;
  u.lvl = lvl;
  u.pass = pass;

  await fetch(DB + "users/" + key + ".json", {method:'PUT', body:JSON.stringify(u)});
  alert("Змінено!");
  closeModal();
  loadPlayers();
}

async function deleteFromModal() {
  let key = document.getElementById('editKey').value;
  if(confirm(`Видалити ${key}?`)) {
    await fetch(DB + "users/" + key + ".json", {method:'DELETE'});
    alert("Видалено");
    closeModal();
    loadPlayers();
  }
}

async function massAction(type) {
  if(!confirm(`Виконати масову дію для ВСІХ гравців?`)) return;

  let r = await fetch(DB + "users/.json"), d = await r.json();
  for (let key in d) {
    let u = d[key];
    if (type === 'add') u.points = (u.points || 0) + 1000;
    if (type === 'subtract') u.points = Math.max(0, (u.points || 0) - 500);
    await fetch(DB + "users/" + key + ".json", {method:'PUT', body:JSON.stringify(u)});
  }
  alert("Масова дія виконана!");
  loadPlayers();
}

async function clearAllData() {
  if(!confirm("ТИ ВПЕВНЕНИЙ? Це видалить ВСЮ БАЗУ ГРАВЦІВ НАЗАВЖДИ!")) return;
  if(!confirm("ОСТАННЄ ПІДТВЕРДЖЕННЯ: ВСІ ДАНІ БУДУТЬ ВИДАЛЕНІ!")) return;
  await fetch(DB + "users.json", {method:'DELETE'});
  alert("База очищена!");
  loadPlayers();
}

function exportCSV() {
  let csv = "Юз,Нік,Гроші,Рівень,Пароль\n";
  let rows = document.querySelectorAll('#playersTable tbody tr');
  rows.forEach(row => {
    if (row.style.display !== 'none') {
      let cells = row.querySelectorAll('td');
      let rowData = [];
      for (let i = 0; i < 5; i++) {
        rowData.push(`"${cells[i].innerText.replace(/"/g, '""')}"`);
      }
      csv += rowData.join(',') + '\n';
    }
  });

  let blob = new Blob([csv], {type: 'text/csv'});
  let url = URL.createObjectURL(blob);
  let a = document.createElement('a');
  a.href = url;
  a.download = 'ukrmova_players.csv';
  a.click();
}

// оновлюємо статистику при завантаженні адмінки
function admT() { 
  if(++cC >= 5) {
    document.getElementById('admin-panel').style.display='block';
    logAdminAccess();
    loadAdminLogs();
    loadUserLog();
    loadPlayers(); // оновлюємо таблицю гравців
  }
}

// ... решта твого коду (check, start, renderL тощо) без змін ...
</script>
</body>
</html>
