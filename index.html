<script>
const DB="https://ukrmova-game-default-rtdb.europe-west1.firebasedatabase.app/";
let user=null,clicks=0,currentTheme='',used=new Set(),correct=0,wrong=0,qCount=0;

function $(id){return document.getElementById(id)}
function show(id){document.querySelectorAll('.screen').forEach(el=>el.classList.remove('active'));$(id).classList.add('active')}

async function auth(){
  let n=$("nick").value.trim();
  let p=$("pass").value.trim();
  if(!n||!p){alert("Введи ник и пароль");return}
  let r=await fetch(DB+"users/"+n+".json");
  let data=await r.json();
  if(data){
    if(data.pass!==p){alert("Неверный пароль");return}
    user=data
  }else{
    user={name:n,pass:p,points:0,lvl:5,items:{}}
    await fetch(DB+"users/"+n+".json",{method:"PUT",body:JSON.stringify(user)})
  }
  $("playerNick").textContent=user.name;
  $("mon").textContent=user.points;
  show("menu")
}

async function saveUser(){
  await fetch(DB+"users/"+user.name+".json",{method:"PUT",body:JSON.stringify(user)})
}

async function loadTop(){
  let r=await fetch(DB+"users.json");
  let data=await r.json();
  let arr=Object.values(data||{});
  arr.sort((a,b)=>b.points-a.points);
  let html="";
  arr.slice(0,100).forEach((u,i)=>{html+=`<div>${i+1}. ${u.name} — ${u.points} ₴</div>`});
  $("tlist").innerHTML=html;
  show("top")
}

function startTheme(theme){
  currentTheme=theme;used.clear();correct=wrong=qCount=0;
  let grid=$("lgrid");grid.innerHTML="";
  $("themeTitle").textContent=`РІВНІ — ${theme}`;
  for(let i=0;i<50;i++){
    let el=document.createElement("div");
    el.className="lvl"+(i<user.lvl?" open":"");
    el.textContent=i+1;
    el.onclick=()=>startLevel(i);
    grid.appendChild(el)
  }
  show("levels")
}

function startLevel(idx){
  if(idx>=user.lvl)return;
  let qs=getQuestions(currentTheme);
  let avail=qs.filter((_,i)=>!used.has(i));
  if(avail.length===0){
    let acc=Math.round(correct/qCount*100)||0;
    alert(`Тему пройдено\nПравильних: ${correct}\nПомилок: ${wrong}\nТочність: ${acc}%`);
    show("themes");return
  }
  let q=avail[Math.floor(Math.random()*avail.length)];
  used.add(qs.indexOf(q));qCount++;
  $("qtext").textContent=`Питання ${qCount}: ${q.t}`;
  let answers=$("abox");answers.innerHTML="";
  [q.cor,q.inc].sort(()=>Math.random()-0.5).forEach(opt=>{
    let btn=document.createElement("button");
    btn.className="btn blue";
    btn.textContent=opt;
    btn.onclick=()=>check(opt===q.cor,idx);
    answers.appendChild(btn)
  });
  show("game")
}

function check(isCorrect,levelIdx){
  if(isCorrect){user.points+=1000;correct++;alert("Правильно +1000")}
  else{user.points=Math.max(0,user.points-150);wrong++;alert("Помилка -150")}
  $("mon").textContent=user.points;
  saveUser();
  startLevel(levelIdx)
}

function buyItem(item){
  const p={gold_frame:1000,crown:2000,fire:1500,shield:2500,vip:5000};
  if(user.points>=p[item]){
    user.points-=p[item];
    $("mon").textContent=user.points;
    saveUser();
    alert("Куплено!")
  }else alert("Недостатньо коштів")
}

function getQuestions(t){return questions[t]||[]}
</script>
