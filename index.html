import asyncio
import logging
import random
from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.storage.memory import MemoryStorage
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton

# ------------------ Налаштування ------------------
TOKEN = "YOUR_BOT_TOKEN_HERE"
logging.basicConfig(level=logging.INFO)

bot = Bot(token=TOKEN)
storage = MemoryStorage()
dp = Dispatcher(storage=storage)

# Приклад бази питань (можна розширити до 500+)
QUESTIONS = {
    "vydminy": [
        {"id": 1, "text": "До якої відміни належить слово «книга»?", "correct": "перша відміна", "wrong": "друга відміна"},
        {"id": 2, "text": "До якої відміни належить слово «стіл»?", "correct": "друга відміна", "wrong": "перша відміна"},
        # ... додай ще 48 питань для цієї теми
        # і так для інших тем
    ],
    # "chasyslova": [...],
    # "prykmetnyky": [...],
    # тощо — заповни сам або зроби окремий файл
}

# ------------------ FSM стани ------------------
class Quiz(StatesGroup):
    choosing_theme = State()
    answering = State()


# Ключ: user_id → { "theme": str, "seen": set[int], "correct": int, "total": int }
user_quiz_data = {}


@dp.message(Command("start"))
async def cmd_start(message: types.Message, state: FSMContext):
    await message.answer(
        "Привіт! Обери тему для тесту:\n"
        "/vydminy   — Відміни іменників\n"
        "/chasyslova — Часи дієслів\n"
        # додай інші команди або зроби кнопки
    )


@dp.message(Command("vydminy"))
async def start_vydminy(message: types.Message, state: FSMContext):
    user_id = message.from_user.id
    user_quiz_data[user_id] = {
        "theme": "vydminy",
        "seen": set(),
        "correct": 0,
        "total": 0
    }
    await state.set_state(Quiz.answering)
    await send_next_question(message, user_id)


async def send_next_question(message_or_call: types.Message | types.CallbackQuery, user_id: int):
    data = user_quiz_data.get(user_id)
    if not data:
        await bot.send_message(user_id, "Сесія не знайдена. Почни заново /start")
        return

    theme = data["theme"]
    seen = data["seen"]
    qlist = QUESTIONS.get(theme, [])

    available = [q for q in qlist if q["id"] not in seen]

    if not available:
        # Тема закінчилася
        percent = round(data["correct"] / data["total"] * 100, 1) if data["total"] else 0
        text = (
            f"Тему «{theme}» завершено!\n"
            f"Правильних: {data['correct']}\n"
            f"Всього: {data['total']}\n"
            f"Точність: {percent}%"
        )
        await bot.send_message(user_id, text)
        # Очищаємо дані
        del user_quiz_data[user_id]
        return

    question = random.choice(available)
    seen.add(question["id"])

    data["total"] += 1

    kb = InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(text=question["correct"], callback_data=f"correct_{question['id']}"),
            InlineKeyboardButton(text=question["wrong"],   callback_data=f"wrong_{question['id']}"),
        ]
    ])

    text = f"Питання {data['total']}\n\n{question['text']}"
    if isinstance(message_or_call, types.Message):
        await message_or_call.answer(text, reply_markup=kb)
    else:
        await message_or_call.message.edit_text(text, reply_markup=kb)


@dp.callback_query(lambda c: c.data.startswith(("correct_", "wrong_")))
async def process_answer(callback: types.CallbackQuery):
    user_id = callback.from_user.id
    data = user_quiz_data.get(user_id)
    if not data:
        await callback.answer("Сесія закінчилася", show_alert=True)
        return

    action, qid = callback.data.split("_", 1)
    qid = int(qid)

    is_correct = action == "correct"

    if is_correct:
        data["correct"] += 1
        await callback.answer("Правильно! ✅", show_alert=False)
    else:
        await callback.answer("Помилка ❌", show_alert=False)

    # Показуємо наступне питання
    await send_next_question(callback, user_id)


async def main():
    await dp.start_polling(bot)


if __name__ == "__main__":
    asyncio.run(main())
